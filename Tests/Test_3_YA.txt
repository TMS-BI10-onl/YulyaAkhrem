/* Yulya Akhremchyk - test 3

1. Найти количество обращений по отделениям в каждом месяце прошлого года. Вывести в виде транспонированной таблицы.*/

SELECT ID_отделения, [1], [2], [3], [4], [5], [6], [7], [8], [9], [10], [11], [12]
FROM 
(SELECT ID_отделения, YEAR(дата_обращения) as Year, MONTH(дата_обращения) AS Month, ID_посещения
	FROM Прием больных
	WHERE YEAR(дата_обращения) = YEAR (DATEADD (year,1 ,getdate()))
) AS SourceTable
PIVOT
(
COUNT(ID_посещения)
	FOR Month IN ([1], [2], [3], [4], [5], [6], [7], [8], [9], [10], [11], [12])
)  AS PivotTable

/* 2. Найти больных, которые повторно обратились в больницу c тем же диагнозом в течение одного года.
Вывести все посещения, а для них: больного, диагноз, дату, врача.*/

SELECT 	п.ФИО,
	д.название_заболевания, 
	COUNT (д.название_заболевания) OVER (PARTITION BY п.ID_пациента, YEAR (пб.дата_обращения)),
	пб.ID_посещения,
	пб.дата_обращения, 
	в.ФИО
	FROM Прием больных пб
		JOIN Пациент п ON пб.ID_пациента = п.ID_пациента
		JOIN Врачи в ON пб.ID_врача = в.ID_врача
		JOIN Диагнозы д ON пб.ID_диагноза = д.ID_диагноза
	GROUP BY п.ФИО, д.название_заболевания, пб.ID_посещения, YEAR(пб.дата_обращения), в.ФИО
	HAVING COUNT (д.название_заболевания) > 1